<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Youtube Play Control</title>
        <script type="text/javascript">
            var player;
            var videoList = {
                videos: [],
                size: function() {
                    return this.videos.length;
                },
                addVideo: function(videoId) {
                    var newVideo = {
                        VIDEO_ID: videoId,
                        VIDEO_TITLE: "unknown"
                    }
                    this.videos.push(newVideo);
                    console.log("Current videos size: " + this.size());
                },
                deleteVideo: function(deleteIndex) {
                    if(deleteIndex < 0 || deleteIndex >= this.size()) {
                        console.log("Invalide video index to delete: " + deleteIndex + ", current size: " + this.size() );
                        return;
                    }
                    var deletedVideo = this.videos.splice(deleteIndex, 1);
                    console.log("delete video " + deletedVideo[0].VIDEO_TITLE);
                },
                getIdList: function() {
                    var idList = [];
                    for(var index = 0; index < this.videos.length; index++) {
                        idList.push(this.videos[index].VIDEO_ID);
                    }
                    return idList;
                },
                getTitleList: function() {
                    var titleList = [];
                    for(var index = 0; index < this.videos.length; index++) {
                        titleList.push(this.videos[index].VIDEO_TITLE);
                    }
                    return titleList;
                },
                updateVideoTitle: function(videoId, videoTitle) {
                    console.log("id: " + videoId);
                    console.log("title: " + videoTitle);
                    for(var index = 0; index < this.videos.length; index++) {
                        if(this.videos[index].VIDEO_ID === videoId) {
                            this.videos[index].VIDEO_TITLE = videoTitle;
                        }
                    }
                    this.showInfo();
                },
                showInfo: function() {
                    for(var index = 0; index < this.videos.length; index++) {
                        console.log(index + ". " + this.videos[index].VIDEO_TITLE + "(" + this.videos[index].VIDEO_ID + ")");
                    }
                }
            }
            var cmd = "";

            var CMD_PLAY = "play";
            var CMD_PAUSE = "pause";
            var CMD_STOP = "stop";
            var CMD_REWIND = "rewind";
            var CMD_NEXT = "next";
            var CMD_PREVIOUS = "previous";
            var CMD_VOLUME_UP = "volume_up";
            var CMD_VOLUME_DOWN = "volume_down";
            var CMD_SEEK_TO = "seek_to";

            var VIDEO_ID = "video_id";
            var VIDEO_TITLE = "video_title";
            document.onkeyup = function(event){
                var key = String.fromCharCode(event.keyCode);
                var keyCode = event.keyCode;
                document.getElementById('key_code').innerHTML = key + "(" + keyCode + ")";
                switch(key) {
                    case "p":
                    case "P":
                        if(player) {
                            var state = player.getPlayerState();
                            if(state == YT.PlayerState.PLAYING) {
                                executeCommand(CMD_PAUSE);
                            } else {
                                executeCommand(CMD_PLAY);
                            }
                        }
                        return;
                    case "S":
                    case "s":
                        executeCommand(CMD_STOP);
                        return;
                    case "R":
                    case "r":
                        executeCommand(CMD_REWIND);
                        return;
                    case "N":
                    case "n":
                        executeCommand(CMD_NEXT);
                        return;
                    case "B":
                    case "b":
                        executeCommand(CMD_PREVIOUS);
                        return;
                    case "A":
                    case "a":
                        if(player) {
                            pauseVideo();
                        }
                        var videoUrl = showAddVideoPrompt();
                        var videoId = parseVideoUrl(videoUrl);
                        if(videoId) {
                            addVideo(videoId);
                        } else {
                            updateStatusInfo("Invalid video URL!");
                            if(player && videoList.size() > 0) {
                                playVideo();
                            }
                        }
                        cmd = "";
                        return;
                    case "D":
                    case "d":
                        var videoIndexToDelete = parseInt(cmd) - 1;
                        videoList.deleteVideo(videoIndexToDelete);
                        if(player) {
                            if(videoList.size() == 0) {
                                player.destroy();
                                initYTPlayer();
                            } else {
                                var currentTime = player.getCurrentTime();
                                if(! currentTime) {
                                    currentTime = 0;
                                }
                                var currentPlayIndex = player.getPlaylistIndex();
                                if(! currentPlayIndex || currentPlayIndex == videoIndexToDelete) {
                                    currentPlayIndex = 0;
                                    currentTime = 0;
                                }
                                player.cuePlaylist(videoList.getIdList(), currentPlayIndex, currentTime, "default");
                            }
                        }
                        updateVideoTitles();
                        cmd = "";
                        return;
                    case "0":
                    case "1":
                    case "2":
                    case "3":
                    case "4":
                    case "5":
                    case "6":
                    case "7":
                    case "8":
                    case "9":
                        cmd = cmd + key;
                        if(cmd.length > 4) {
                            cmd = "";
                        }
                        updateStatusInfo(cmd);
                        return;
                }

                switch(keyCode) {
                    case 61: /* + key */
                        executeCommand(CMD_VOLUME_UP);
                        break;
                    case 173: /* - key */
                        executeCommand(CMD_VOLUME_DOWN);
                        break;
                    case 190: /* > key */
                        var currentTime = player.getCurrentTime();
                        var duration = player.getDuration();
                        var seekTo = currentTime + parseInt(cmd);
                        if(seekTo > duration) {
                            console.log("Cannot seek to " + seekTo);
                            updateStatusInfo("Invalid command!");
                            cmd = "";
                        } else {
                            executeCommand(CMD_SEEK_TO, seekTo);
                        }
                        return;
                    case 188: /* < key */
                        var currentTime = player.getCurrentTime();
                        var duration = player.getDuration();
                        var seekTo = currentTime - parseInt(cmd);
                        if(seekTo < 0) {
                            console.log("Cannot seek to " + seekTo);
                            updateStatusInfo("Invalid command!");
                            cmd = "";
                        } else {
                            executeCommand(CMD_SEEK_TO, seekTo);
                        }
                        return;
                }
            }

            console.log("Load the IFrame Player API code asynchronously...");
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

            console.log("Create a YouTube player...");
            function onYouTubeIframeAPIReady() {
                console.log("Youtube Iframe API is ready.");
                initYTPlayer();
            }
            
            function onPlayerReady(event) {
                console.log("Player is ready.");
                if(videoList.size() > 0) {
                    event.target.loadPlaylist(videoList.getIdList());
                }
            }

            function onPlayerStateChange(event) {
                console.log("Player state changes " + event.data);
                if (event.data == YT.PlayerState.CUED) {
                    event.target.playVideo();
                }
            }

            function executeCommand(commandToExecute, value) {
                switch(commandToExecute) {
                    case CMD_PLAY:
                        playVideo();
                        break;
                    case CMD_PAUSE:
                        pauseVideo();
                        break;
                    case CMD_STOP:
                        stopVideo();
                        break;
                    case CMD_REWIND:
                        rewind();
                        playVideo();
                        break;
                    case CMD_NEXT:
                        playNextVideo();
                        break;
                    case CMD_PREVIOUS:
                        playPreviousVideo();
                        break;
                    case CMD_VOLUME_UP:
                        volumeUp();
                        break;
                    case CMD_VOLUME_DOWN:
                        volumeDown();
                        break;
                    case CMD_SEEK_TO:
                        seekTo(value);
                        playVideo();
                        break;
                }
                cmd = "";
                updateStatusInfo(cmd);
            }

            function playVideo() {
                console.log("playVideo");
                player.playVideo();
            }

            
            function pauseVideo() {
                console.log("pauseVideo");
                player.pauseVideo();
            }

            function stopVideo() {
                console.log("stopVideo");
                player.stopVideo();
            }

            function rewind() {
                console.log("rewind");
                player.seekTo(0, true);
            }

            function seekTo(seconds) {
                console.log("seekTo");
                player.seekTo(seconds, true);
            }

            function playNextVideo() {
                console.log("playNextVideo");
                player.nextVideo();
            }

            function playPreviousVideo() {
                console.log("playPreviousVideo");
                player.previousVideo();
            }

            function volumeUp() {
                console.log("volumeUp");
                var volume = player.getVolume();
                volume += 10;
                if(volume > 100) {
                    volume = 100;
                }
                player.setVolume(volume);
            }

            function volumeDown() {
                console.log("volumeDown");
                var volume = player.getVolume();
                volume -= 10;
                if(volume < 0) {
                    volume = 0;
                }
                player.setVolume(volume);
            }

            function showAddVideoPrompt() {
                return prompt("Add video");
            }

            function addVideo(videoId) {
                updateStatusInfo("Video " + videoId + " is added.");
                videoList.addVideo(videoId);
                loadVideoTitle(videoId);
                if(player) {
                    var currentPlayIndex = player.getPlaylistIndex();
                    if(! currentPlayIndex) {
                        currentPlayIndex = 0;
                    }
                    var currentTime = player.getCurrentTime();
                    if(! currentTime) {
                        currentTime = 0;
                    }
                    player.cuePlaylist(videoList.getIdList(), currentPlayIndex, currentTime, "default");
                }
            }

            function parseVideoUrl(url) {
                var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                var match = url.match(regExp);
                if (match && match[2].length==11) {
                    return match[2];
                }
            }

            function loadVideoTitle(videoId) {
                console.log("loadVideoTitle");
                var gdata = document.createElement("script");
                gdata.src = "http://gdata.youtube.com/feeds/api/videos/" + videoId + "?v=2&alt=jsonc&callback=loadVideoTitleCallback";
                var body = document.getElementsByTagName("body")[0];
                body.appendChild(gdata);
            }

            function loadVideoTitleCallback(info) {
                videoList.updateVideoTitle(info.data.id, info.data.title);
                updateVideoTitles();
            }

            function updateVideoTitles() {
                console.log("updateVideoTitles");
                var playList = document.getElementById('play_list');
                while(playList.firstChild) {
                    playList.removeChild(playList.firstChild);
                }
                var titleList = videoList.getTitleList();
                for(var index = 0; index < titleList.length; index++) {
                    var entry = document.createElement('li');
                    entry.appendChild(document.createTextNode(titleList[index]));
                    playList.appendChild(entry);
                }
            }

            function updateStatusInfo(msg) {
                document.getElementById('status').innerHTML = msg;
            }

            function initYTPlayer() {
                player = new YT.Player(
                    'player', {
                        height: '390',
                        width: '640',
                        events: {
                            'onReady': onPlayerReady,
                            'onStateChange': onPlayerStateChange
                        }
                    }
                );
            }
        </script>
	</head>
	<body>
        <div id="player"></div>
        </br>
        Key Code: <span id="key_code"></span>
        Status: <span id="status"></span>
        <ul id="play_list"></ul>
	</body>
</html>
